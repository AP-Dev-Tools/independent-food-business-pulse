<!DOCTYPE html>

<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Industry Pulse Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
    body{font-family:'Inter',sans-serif;background:#f7f9fb}
    .card{background:#fff;padding:1.5rem;border-radius:12px;box-shadow:0 4px 6px -1px rgba(0,0,0,.1)}
    .header-bg{background:#0b1c3c;color:#fff;padding:1rem 0;margin-bottom:2rem}
    th{ text-align:left;padding:.5rem .75rem;background:#e2e8f0;border-bottom:2px solid #cbd5e1;font-size:.875rem}
    td{ padding:.75rem;border-bottom:1px solid #e2e8f0;font-size:.875rem}
    .text-positive{color:#10b981}
    .text-negative{color:#ef4444}
    .table-container{overflow-x:auto;border-radius:8px}
    .upload-zone{border:2px dashed #cbd5e1;border-radius:8px;padding:2rem;text-align:center;background:#f9fafb;transition:.3s}
    .upload-zone:hover{border-color:#3b82f6;background:#eff6ff}
    .progress-bar{width:100%;background:#e5e7eb;border-radius:9999px;overflow:hidden;height:24px}
    .progress-fill{height:100%;background:#3b82f6;transition:width .3s ease;display:flex;align-items:center;justify-content:center;color:#fff;font-size:.875rem;font-weight:600}
    .history-badge{display:inline-block;background:#dbeafe;color:#1e40af;padding:.25rem .75rem;border-radius:9999px;font-size:.75rem;font-weight:600}
    .spinner{border:3px solid #f3f4f6;border-top:3px solid #3b82f6;border-radius:50%;width:20px;height:20px;animation:spin 1s linear infinite;display:inline-block}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}

```
.card canvas {
  max-height: 400px !important;
  height: 400px !important;
}
```

  </style>
</head>
<body class="min-h-screen">
  <div class="header-bg">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex items-center justify-between">
      <div>
        <h1 class="text-3xl font-extrabold tracking-tight">Industry Pulse Dashboard</h1>
        <p class="text-gray-300 mt-1">Birds-eye view of registered businesses</p>
        <p id="user-info" class="text-xs mt-2 text-gray-400">V1</p>
      </div>
      <div class="flex space-x-2">
        <button onclick="fetchLatestData()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm font-medium">üîÑ Fetch Latest Data</button>
        <button onclick="openSettings()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm font-medium">‚öôÔ∏è Settings</button>
      </div>
    </div>
  </div>

  <!-- Settings Modal -->

  <div id="settings-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
    <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
      <h2 class="text-xl font-bold mb-4">‚öôÔ∏è Automation Settings</h2>
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Day of Week</label>
          <select id="setting-day" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
            <option value="1">Monday</option><option value="2">Tuesday</option><option value="3">Wednesday</option>
            <option value="4">Thursday</option><option value="5">Friday</option><option value="6">Saturday</option><option value="0">Sunday</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Time (24-hour format)</label>
          <input type="time" id="setting-time" value="09:00" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Timezone</label>
          <select id="setting-timezone" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
            <option value="Europe/London">Europe/London (UK)</option>
            <option value="America/New_York">America/New_York (EST)</option>
            <option value="America/Los_Angeles">America/Los_Angeles (PST)</option>
            <option value="Europe/Paris">Europe/Paris (CET)</option>
          </select>
        </div>
      </div>
      <div class="mt-6 flex space-x-3">
        <button onclick="copySettings()" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium">üìã Copy Settings</button>
        <button onclick="closeSettings()" class="flex-1 px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 font-medium">Close</button>
      </div>
      <p id="settings-message" class="mt-3 text-sm text-center hidden"></p>
    </div>
  </div>

  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">

```
<!-- Historical Overview Banner -->
<section class="card mb-6 bg-gradient-to-r from-blue-50 to-indigo-50" id="history-banner" style="display:none;">
  <div class="flex items-center justify-between">
    <div>
      <h3 class="text-lg font-semibold text-gray-800">üìä Historical Tracking Active</h3>
      <p class="text-sm text-gray-600 mt-1">You have <span id="history-count" class="font-bold text-blue-600">0</span> weeks of data logged</p>
      <p class="text-xs text-gray-500 mt-1">Using IndexedDB - No storage limits!</p>
    </div>
    <button onclick="clearHistory()" class="px-4 py-2 text-sm text-red-600 border border-red-300 rounded-lg hover:bg-red-50">Clear All History</button>
  </div>
</section>

<!-- File Upload (manual mode) -->
<section class="card mb-6" id="upload-section">
  <h2 class="text-xl font-semibold text-gray-800 mb-4">üìÅ Load FHRS Data</h2>

  <div class="bg-green-50 border-l-4 border-green-400 p-4 mb-4">
    <div class="flex">
      <div class="flex-shrink-0"><svg class="h-5 w-5 text-green-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg></div>
      <div class="ml-3"><p class="text-sm text-green-700"><strong>IndexedDB Edition!</strong> Handles large data without localStorage limits.</p></div>
    </div>
  </div>

  <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-4">
    <div class="flex">
      <div class="flex-shrink-0"><svg class="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></div>
      <div class="ml-3"><p class="text-sm text-yellow-700"><strong>Important:</strong> Only upload this week‚Äôs XMLs. The system compares to your previous upload.</p></div>
    </div>
  </div>

  <div class="space-y-4">
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-2">Date for This Data:</label>
      <input type="date" id="data-date" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"/>
      <p class="text-xs text-gray-500 mt-1">e.g. from your folder name: 2025-11-03</p>
    </div>

    <div>
      <label class="block text-sm font-medium text-gray-700 mb-2">Select This Week's Data Folder:</label>
      <div class="upload-zone">
        <input type="file" id="current-files" webkitdirectory directory multiple accept=".xml" class="hidden">
        <label for="current-files" class="cursor-pointer">
          <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
            <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <p class="mt-1 text-sm text-gray-600"><span class="font-medium text-blue-600">Click to select folder</span></p>
          <p class="text-xs text-gray-500 mt-1">Choose the folder containing this week‚Äôs XML files.</p>
        </label>
      </div>
      <p id="current-status" class="mt-2 text-sm text-gray-600"></p>
    </div>

    <button onclick="processData()" id="process-button" class="w-full px-6 py-3 text-white bg-blue-600 rounded-lg hover:bg-blue-700 font-medium disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>
      Process Data & Auto-Save to History
    </button>
  </div>

  <div id="processing-section" class="mt-6 hidden">
    <div class="progress-bar"><div id="progress-fill" class="progress-fill" style="width:0%">0%</div></div>
    <p id="progress-detail" class="mt-2 text-sm text-gray-600 text-center">Processing...</p>
  </div>
</section>

<!-- Dashboard Content -->
<div id="app-content" class="space-y-8 hidden">

  <!-- Historical Trends -->
  <section class="card">
    <h2 class="text-xl font-semibold text-gray-800 mb-4">üìà Historical Trends (All Time)</h2>
    <p class="text-sm text-gray-600 mb-4">Automatic tracking of all your uploads over time</p>
    <div class="table-container">
      <table class="min-w-full divide-y divide-gray-200">
        <thead>
          <tr>
            <th>Date</th>
            <th class="text-right">Mobile Caterers</th>
            <th class="text-right">Restaurants</th>
            <th class="text-right">Pubs/Bars</th>
            <th class="text-right">Takeaways</th>
            <th class="text-right">Total</th>
            <th class="text-right">Change vs Previous</th>
          </tr>
        </thead>
        <tbody id="historical-trends" class="bg-white divide-y divide-gray-200"></tbody>
      </table>
    </div>
    <p class="text-xs text-gray-500 mt-3">üí° Data is automatically saved each time you upload new XML files</p>
  </section>

  <!-- Trends Chart -->
  <section class="card">
    <div class="flex items-center justify-between mb-4">
      <div>
        <h2 class="text-xl font-semibold text-gray-800">üìà Industry Trends Over Time</h2>
        <p class="text-sm text-gray-600 mt-1">Visual timeline of business registrations (latest data point per month)</p>
      </div>
      <button onclick="exportChartData()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm font-medium">Export Chart Data</button>
    </div>

    <div class="mb-4">
      <div class="flex items-center justify-between mb-3">
        <label class="block text-sm font-medium text-gray-700">Chart Timeframe:</label>
        <div class="flex space-x-2">
          <button onclick="setChartTimeframe('monthly')" id="timeframe-btn-monthly" class="px-3 py-1 bg-blue-600 text-white rounded text-xs font-medium">Monthly</button>
          <button onclick="setChartTimeframe('weekly')" id="timeframe-btn-weekly" class="px-3 py-1 bg-gray-200 text-gray-700 rounded text-xs font-medium">Weekly</button>
        </div>
      </div>
      <label class="block text-sm font-medium text-gray-700 mb-2">Select Business Type:</label>
      <div class="flex space-x-2">
        <button onclick="updateChart('total')" id="chart-btn-total" class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium">Total</button>
        <button onclick="updateChart('mobile')" id="chart-btn-mobile" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm font-medium">Mobile Caterers</button>
        <button onclick="updateChart('restaurant')" id="chart-btn-restaurant" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm font-medium">Restaurants</button>
        <button onclick="updateChart('pub')" id="chart-btn-pub" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm font-medium">Pubs/Bars</button>
        <button onclick="updateChart('takeaway')" id="chart-btn-takeaway" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm font-medium">Takeaways</button>
      </div>
    </div>

    <div class="bg-white p-4 rounded-lg">
      <canvas id="trendsChart" height="80"></canvas>
    </div>
  </section>

  <!-- Latest vs Previous -->
  <section class="card">
    <h2 id="comparison-heading" class="text-xl font-semibold text-gray-800 mb-1">üìä Latest vs Previous</h2>
    <p id="comparison-sub" class="text-sm text-gray-600 mb-4">Comparing the two most recent snapshots.</p>

    <div id="no-comparison" class="text-center py-8 text-gray-500">
      <p>No previous data yet. Upload again next week to see changes!</p>
    </div>
    <div id="comparison-view" class="hidden">
      <div class="table-container">
        <table class="min-w-full divide-y divide-gray-200">
          <thead>
            <tr>
              <th>Sector</th>
              <th class="text-right">Current Count</th>
              <th class="text-right">Absolute Change</th>
              <th class="text-right">% Change</th>
            </tr>
          </thead>
          <tbody id="national-trends" class="bg-white divide-y divide-gray-200"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- Top 10 Growth -->
  <section class="card">
    <h2 class="text-xl font-semibold text-gray-800 mb-4">üèÜ Top 10 Growth by Local Authority</h2>
    <div class="mb-4 flex items-center space-x-3">
      <div class="flex-1">
        <label class="block text-sm font-medium text-gray-700 mb-2">Select Business Type:</label>
        <select id="growth-sector-select" onchange="updateTopGrowth()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
          <option value="Mobile caterer">Mobile Food Caterers</option>
          <option value="Restaurant/Cafe/Canteen">Restaurants/Cafes</option>
          <option value="Pub/bar/nightclub">Pubs/Bars/Clubs</option>
          <option value="Takeaway/sandwich shop">Takeaways</option>
        </select>
      </div>
      <div id="top-growth-spinner" class="spinner hidden mt-7"></div>
    </div>
    <p class="text-sm text-gray-600 mb-3">Local Authorities with most new businesses this week</p>
    <div class="table-container">
      <table class="min-w-full divide-y divide-gray-200">
        <thead>
          <tr>
            <th>#</th>
            <th>Local Authority</th>
            <th class="text-right">Net Change</th>
            <th class="text-right">Current Total</th>
          </tr>
        </thead>
        <tbody id="regional-ranking-growth" class="bg-white divide-y divide-gray-200">
          <tr><td colspan="4" class="text-center py-4 text-gray-500">Upload again next week to see changes!</td></tr>
        </tbody>
      </table>
    </div>
  </section>

  <!-- Top 10 Reductions -->
  <section class="card">
    <h2 class="text-xl font-semibold text-gray-800 mb-4">üìâ Top 10 Reductions by Local Authority</h2>
    <p class="text-sm text-gray-600 mb-3">Local Authorities with biggest losses this week</p>
    <div class="table-container">
      <table class="min-w-full divide-y divide-gray-200">
        <thead>
          <tr>
            <th>#</th>
            <th>Local Authority</th>
            <th class="text-right">Net Change</th>
            <th class="text-right">Current Total</th>
          </tr>
        </thead>
        <tbody id="regional-ranking-reduction" class="bg-white divide-y divide-gray-200">
          <tr><td colspan="4" class="text-center py-4 text-gray-500">Upload again next week to see changes!</td></tr>
        </tbody>
      </table>
    </div>
  </section>


  <!-- NEW: Daily Trends (Last 30 Days) -->
  <section class="card">
    <h2 class="text-xl font-semibold text-gray-800 mb-4">üìä Daily Trends (Last 30 Days)</h2>
    <p class="text-sm text-gray-600 mb-4">Daily change (growth/decline) - hover for totals</p>
    <div id="daily-loading" class="text-center py-8">
      <div class="spinner mx-auto mb-2"></div>
      <p class="text-sm text-gray-600">Loading daily data...</p>
    </div>
    <div style="height: 400px; max-height: 400px; overflow: hidden;"><canvas id="daily-chart" style="display:none; height: 400px !important; max-height: 400px;"></canvas>
    </div><p id="daily-status" class="text-sm text-gray-500 mt-2 text-center" style="display:none;"></p>
  </section>

  <!-- NEW: Historical Month Browser -->
  <section class="card">
    <h2 class="text-xl font-semibold text-gray-800 mb-4">üóìÔ∏è Historical Daily Trends</h2>
    <p class="text-sm text-gray-600 mb-4">Browse daily patterns for any month (last 12 months)</p>
    <div class="mb-4 flex items-center space-x-3">
      <button onclick="loadPreviousMonth()" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300 text-sm font-medium">‚Üê Previous</button>
      <select id="month-selector" onchange="loadSelectedMonth()" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg">
        <option value="">Loading...</option>
      </select>
      <button onclick="loadNextMonth()" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300 text-sm font-medium">Next ‚Üí</button>
    </div>
    <div id="monthly-loading" class="text-center py-8">
      <div class="spinner mx-auto mb-2"></div>
      <p class="text-sm text-gray-600">Loading month...</p>
    </div>
    <div style="height: 400px; max-height: 400px; overflow: hidden;"><canvas id="monthly-daily-chart" style="display:none; height: 400px !important; max-height: 400px;"></canvas>
    </div><p id="monthly-status" class="text-sm text-gray-500 mt-2 text-center" style="display:none;"></p>
  </section>

  <!-- Export Section - ENHANCED -->
  <section class="card">
    <h2 class="text-xl font-semibold text-gray-800 mb-4">üì• Export New Businesses</h2>
    <p class="text-sm text-gray-600 mb-4">Download CSV with flexible time ranges</p>
    <div class="space-y-4">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Business Type:</label>
        <select id="export-sector-select" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
          <option value="Mobile caterer">Mobile Food Caterers</option>
          <option value="Restaurant/Cafe/Canteen">Restaurants/Cafes</option>
          <option value="Pub/bar/nightclub">Pubs/Bars/Clubs</option>
          <option value="Takeaway/sandwich shop">Takeaways</option>
          <option value="Hotel/bed & breakfast/guest house">Hotels/B&Bs</option>
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Time Range:</label>
        <div class="grid grid-cols-2 gap-2">
          <label class="flex items-center px-3 py-2 border rounded-lg cursor-pointer hover:bg-gray-50">
            <input type="radio" name="time-range" value="month" checked class="mr-2"><span class="text-sm">This Month</span>
          </label>
          <label class="flex items-center px-3 py-2 border rounded-lg cursor-pointer hover:bg-gray-50">
            <input type="radio" name="time-range" value="7" class="mr-2"><span class="text-sm">Last 7 Days</span>
          </label>
          <label class="flex items-center px-3 py-2 border rounded-lg cursor-pointer hover:bg-gray-50">
            <input type="radio" name="time-range" value="14" class="mr-2"><span class="text-sm">Last 14 Days</span>
          </label>
          <label class="flex items-center px-3 py-2 border rounded-lg cursor-pointer hover:bg-gray-50">
            <input type="radio" name="time-range" value="30" class="mr-2"><span class="text-sm">Last 30 Days</span>
          </label>
        </div>
      </div>
      <button onclick="downloadFilteredCsv()" class="w-full px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 font-medium">Download CSV</button>
      <p id="export-status" class="text-sm text-center text-gray-500"></p>
    </div>
  </section>
</div>
```

  </main>

  <script>
    // üîß Switch this to true if you ever want manual upload mode again
    const ENABLE_MANUAL = false;

    const SECTORS = {
      MOBILE:'Mobile caterer',
      RESTAURANT:'Restaurant/Cafe/Canteen',
      PUB:'Pub/bar/nightclub',
      TAKEAWAY:'Takeaway/sandwich shop'
    };

    let currentFiles=[], currentData=[], previousData=[], newBusinesses=[], db;
    let trendsChart=null, currentChartType='total', currentTimeframe='monthly';

    // IndexedDB
    function initDB(){
      return new Promise((resolve,reject)=>{
        const req=indexedDB.open('FHRSDatabase',1);
        req.onerror=()=>reject(req.error);
        req.onsuccess=()=>{db=req.result;resolve(db);};
        req.onupgradeneeded=(e)=>{
          const d=e.target.result;
          if(!d.objectStoreNames.contains('snapshots')){
            const s=d.createObjectStore('snapshots',{keyPath:'date'});
            s.createIndex('date','date',{unique:true});
          }
        };
      });
    }

    async function saveSnapshot(date,businesses){
      const snapshot={
        date,
        businesses: businesses.map(b=>({
          id:b.id,name:b.name,type:b.type,la:b.la,address:b.address,
          addressLine1:b.addressLine1,addressLine2:b.addressLine2,addressLine3:b.addressLine3,addressLine4:b.addressLine4,
          postcode:b.postcode,ratingValue:b.ratingValue,ratingDate:b.ratingDate
        })),
        counts:{
          [SECTORS.MOBILE]: businesses.filter(b=>b.type===SECTORS.MOBILE).length,
          [SECTORS.RESTAURANT]: businesses.filter(b=>b.type===SECTORS.RESTAURANT).length,
          [SECTORS.PUB]: businesses.filter(b=>b.type===SECTORS.PUB).length,
          [SECTORS.TAKEAWAY]: businesses.filter(b=>b.type===SECTORS.TAKEAWAY).length,
          total: businesses.length
        }
      };
      return new Promise((resolve,reject)=>{
        const tx=db.transaction(['snapshots'],'readwrite');
        const store=tx.objectStore('snapshots');
        const r=store.put(snapshot);
        r.onsuccess=()=>resolve();
        r.onerror=()=>reject(r.error);
      });
    }

    async function loadAllSnapshots(){
      return new Promise((resolve,reject)=>{
        const tx=db.transaction(['snapshots'],'readonly');
        const store=tx.objectStore('snapshots');
        const r=store.getAll();
        r.onsuccess=()=>{const s=r.result||[];s.sort((a,b)=>a.date.localeCompare(b.date));resolve(s);};
        r.onerror=()=>reject(r.error);
      });
    }
    async function getLatestSnapshot(){const s=await loadAllSnapshots();return s.length?s[s.length-1]:null;}

    async function clearHistory(){
      if(!confirm('Clear all historical data?')) return;
      return new Promise((resolve,reject)=>{
        const tx=db.transaction(['snapshots'],'readwrite');
        const store=tx.objectStore('snapshots');
        const r=store.clear();
        r.onsuccess=()=>{location.reload();resolve();};
        r.onerror=()=>reject(r.error);
      });
    }

    async function updateStorageDisplay(){
      const s=await loadAllSnapshots();
      document.getElementById('history-count').textContent=s.length;
      if(s.length>0) document.getElementById('history-banner').style.display='block';
    }

    async function displayHistoricalTrends(){
      const snapshots=await loadAllSnapshots();
      const tb=document.getElementById('historical-trends'); tb.innerHTML='';
      if(!snapshots.length) return;
      snapshots.forEach((snap,idx)=>{
        const isLatest=idx===snapshots.length-1, badge=isLatest? ' <span class="history-badge">LATEST</span>':'';
        const c=snap.counts||{}, mobile=c[SECTORS.MOBILE]||0, restaurant=c[SECTORS.RESTAURANT]||0, pub=c[SECTORS.PUB]||0, takeaway=c[SECTORS.TAKEAWAY]||0, total=c.total||0;
        let changeCell='<td class="text-right text-gray-400">-</td>';
        if(idx>0){ const prev=snapshots[idx-1].counts?.total||0; const ch=total-prev; changeCell=`<td class="text-right">${formatChange(ch)}</td>`; }
        tb.innerHTML+=`<tr>
          <td class="font-medium">${snap.date}${badge}</td>
          <td class="text-right">${mobile.toLocaleString()}</td>
          <td class="text-right">${restaurant.toLocaleString()}</td>
          <td class="text-right">${pub.toLocaleString()}</td>
          <td class="text-right">${takeaway.toLocaleString()}</td>
          <td class="text-right font-semibold">${total.toLocaleString()}</td>
          ${changeCell}
        </tr>`;
      });

      if(snapshots.length>=2){
        const a=snapshots[snapshots.length-1].date, b=snapshots[snapshots.length-2].date;
        const sub=document.getElementById('comparison-sub');
        if(sub) sub.textContent=`Comparing ${a} vs ${b}.`;
      }
    }

    // File handling (manual) ‚Äî left in but disabled if ENABLE_MANUAL=false
    document.getElementById('current-files').addEventListener('change',(e)=>{
      currentFiles=Array.from(e.target.files).filter(f=>f.name.endsWith('.xml'));
      document.getElementById('current-status').textContent=`‚úì ${currentFiles.length} XML files selected`;
      if(currentFiles.length){
        const p=currentFiles[0].webkitRelativePath||currentFiles[0].name;
        const m=p.match(/(\d{4}-\d{2}-\d{2})/); if(m) document.getElementById('data-date').value=m[1];
      }
      updateProcessButton();
    });
    document.getElementById('data-date').addEventListener('change',updateProcessButton);
    function updateProcessButton(){
      const hasFiles=currentFiles.length>0, hasDate=document.getElementById('data-date').value!=='';
      document.getElementById('process-button').disabled=!(hasFiles&&hasDate);
    }

    async function processData(){
      if(!ENABLE_MANUAL){ return; }
      const dataDate=document.getElementById('data-date').value; if(!dataDate){alert('Select a date');return;}
      document.getElementById('processing-section').classList.remove('hidden');
      document.getElementById('process-button').disabled=true;

      currentData=[]; const latest=await getLatestSnapshot(); previousData=latest?latest.businesses:[];
      const total=currentFiles.length;
      for(let i=0;i<total;i++){
        const pct=Math.round(((i+1)/total)*100);
        document.getElementById('progress-fill').style.width=`${pct}%`;
        document.getElementById('progress-fill').textContent=`${pct}%`;
        document.getElementById('progress-detail').textContent=`Processing ${i+1} of ${total} files...`;
        await parseXMLFile(currentFiles[i]); await new Promise(r=>setTimeout(r,10));
      }
      document.getElementById('progress-detail').textContent='Identifying new businesses...';
      identifyNewBusinesses();
      document.getElementById('progress-detail').textContent='Saving to database...';
      await saveSnapshot(dataDate,currentData);
      document.getElementById('progress-detail').textContent='Complete! Loading dashboard...';
      await new Promise(r=>setTimeout(r,500));
      document.getElementById('upload-section').classList.add('hidden');
      document.getElementById('app-content').classList.remove('hidden');
      await runPulseCalculations();
    }

    function identifyNewBusinesses(){
      if(!Array.isArray(previousData)||!previousData.length){ newBusinesses=currentData.slice(); return; }
      const prevIds=new Set(previousData.map(b=>b.id).filter(Boolean));
      newBusinesses=currentData.filter(b=>b.id && !prevIds.has(b.id));
    }

    async function parseXMLFile(file){
      return new Promise((resolve)=>{
        const reader=new FileReader();
        reader.onload=(e)=>{
          const parser=new DOMParser(); const xml=parser.parseFromString(e.target.result,'text/xml');
          const ests=xml.getElementsByTagName('EstablishmentDetail');
          for(let est of ests){
            const type=est.getElementsByTagName('BusinessType')[0]?.textContent||'';
            if(Object.values(SECTORS).includes(type)){
              const a1=est.getElementsByTagName('AddressLine1')[0]?.textContent||'';
              const a2=est.getElementsByTagName('AddressLine2')[0]?.textContent||'';
              const a3=est.getElementsByTagName('AddressLine3')[0]?.textContent||'';
              const a4=est.getElementsByTagName('AddressLine4')[0]?.textContent||'';
              const postcode=est.getElementsByTagName('PostCode')[0]?.textContent||'';
              const address=[a1,a2,a3,a4].filter(x=>x.trim()!=='').join(', ');
              currentData.push({
                id: est.getElementsByTagName('FHRSID')[0]?.textContent||'',
                name: est.getElementsByTagName('BusinessName')[0]?.textContent||'',
                type, la: est.getElementsByTagName('LocalAuthorityName')[0]?.textContent||'',
                address,addressLine1:a1,addressLine2:a2,addressLine3:a3,addressLine4:a4,
                postcode, ratingValue: est.getElementsByTagName('RatingValue')[0]?.textContent||'',
                ratingDate: est.getElementsByTagName('RatingDate')[0]?.textContent||''
              });
            }
          }
          resolve();
        };
        reader.readAsText(file);
      });
    }

    // Calculations
    function calculateSectorPulse(curr,prev,sectors,laFilter=null){
      const filt=la=>laFilter?la===laFilter:true;
      const cCnt=curr.filter(e=>filt(e.la)).reduce((a,e)=>{ if(sectors.includes(e.type)) a[e.type]=(a[e.type]||0)+1; return a; },{});
      const pCnt=prev.filter(e=>filt(e.la)).reduce((a,e)=>{ if(sectors.includes(e.type)) a[e.type]=(a[e.type]||0)+1; return a; },{});
      const res={};
      for(const s of sectors){
        const cc=cCnt[s]||0, pc=pCnt[s]||0, ac=cc-pc;
        let pct=0; if(pc>0) pct=(ac/pc)*100; else if(cc>0) pct=100;
        res[s]={currentCount:cc,prevCount:pc,absoluteChange:ac,percentChange:pct.toFixed(2)};
      }
      return res;
    }

    function calculateRegionalRanking(curr,prev,sector,order='desc'){
      if(prev.length===0) return [];
      const las=[...new Set([...curr.map(e=>e.la),...prev.map(e=>e.la)])];
      const rows=las.map(la=>{
        const p=calculateSectorPulse(curr,prev,[sector],la);
        return {la, absoluteChange:p[sector].absoluteChange, currentTotal:p[sector].currentCount};
      }).filter(r=>order==='desc'?r.absoluteChange>0:r.absoluteChange<0);
      rows.sort((a,b)=>order==='desc'? b.absoluteChange-a.absoluteChange : a.absoluteChange-b.absoluteChange);
      return rows.slice(0,10);
    }

    function formatChange(c){
      const n=parseFloat(c); if(isNaN(n)) return 'N/A';
      const sign=n>=0?'+':'', col=n>=0?'text-positive':'text-negative', icon=n>0?'‚ñ≤':(n<0?'‚ñº':'‚ñ¨');
      return `<span class="${col} font-semibold">${icon} ${sign}${n.toLocaleString()}</span>`;
    }

    function renderPulseTable(tid,res){
      const tb=document.getElementById(tid); tb.innerHTML='';
      for(const s in res){
        const d=res[s];
        tb.innerHTML+=`<tr>
          <td class="font-medium text-gray-900">${s}</td>
          <td class="text-right">${d.currentCount.toLocaleString()}</td>
          <td class="text-right">${formatChange(d.absoluteChange)}</td>
          <td class="text-right">${d.percentChange}%</td>
        </tr>`;
      }
    }

    function renderRegionalRanking(data,tableId){
      const tb=document.getElementById(tableId); tb.innerHTML='';
      if(!data.length){ tb.innerHTML='<tr><td colspan="4" class="text-center py-4 text-gray-500">No comparison data available yet.</td></tr>'; return; }
      data.forEach((item,i)=>{
        tb.innerHTML+=`<tr><td>${i+1}</td><td class="font-medium text-gray-900">${item.la}</td><td class="text-right">${formatChange(item.absoluteChange)}</td><td class="text-right">${item.currentTotal.toLocaleString()}</td></tr>`;
      });
    }

    function updateTopGrowth(){
      const sector=document.getElementById('growth-sector-select').value;
      const spinner=document.getElementById('top-growth-spinner');
      const sel=document.getElementById('growth-sector-select');
      spinner.classList.remove('hidden'); sel.disabled=true;
      setTimeout(()=>{
        if(previousData.length===0){ spinner.classList.add('hidden'); sel.disabled=false; return; }
        const growth=calculateRegionalRanking(currentData,previousData,sector,'desc');
        const reductions=calculateRegionalRanking(currentData,previousData,sector,'asc');
        renderRegionalRanking(growth,'regional-ranking-growth');
        renderRegionalRanking(reductions,'regional-ranking-reduction');
        spinner.classList.add('hidden'); sel.disabled=false;
      },100);
    }

    function openSettings(){document.getElementById('settings-modal').classList.remove('hidden');}
    function closeSettings(){document.getElementById('settings-modal').classList.add('hidden');document.getElementById('settings-message').classList.add('hidden');}
    function copySettings(){
      const day=document.getElementById('setting-day').value;
      const time=document.getElementById('setting-time').value;
      const tz=document.getElementById('setting-timezone').value;
      const [hour,minute]=time.split(':');
      const cfg={schedule:{day:+day,hour:+hour,minute:+minute,timezone:tz},cron:`${minute} ${hour} * * ${day}`,readable:`Every ${['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'][+day]} at ${time} ${tz}`};
      navigator.clipboard.writeText(JSON.stringify(cfg,null,2)).then(()=>{
        const m=document.getElementById('settings-message'); m.textContent='‚úÖ Copied! Paste into config.json in your GitHub repo'; m.className='mt-3 text-sm text-center text-green-600 font-medium'; m.classList.remove('hidden');
      });
    }

    function setChartTimeframe(tf){
      currentTimeframe=tf;
      const m=document.getElementById('timeframe-btn-monthly'), w=document.getElementById('timeframe-btn-weekly');
      if(tf==='monthly'){ m.className='px-3 py-1 bg-blue-600 text-white rounded text-xs font-medium'; w.className='px-3 py-1 bg-gray-200 text-gray-700 rounded text-xs font-medium'; }
      else { m.className='px-3 py-1 bg-gray-200 text-gray-700 rounded text-xs font-medium'; w.className='px-3 py-1 bg-blue-600 text-white rounded text-xs font-medium'; }
      createChart();
    }

    async function getWeeklyDataPoints(){ const s=await loadAllSnapshots(); return s.sort((a,b)=>a.date.localeCompare(b.date)); }
    async function getMonthlyDataPoints(){
      const s=await loadAllSnapshots(); const monthly={};
      s.forEach(x=>{ const k=x.date.slice(0,7); if(!monthly[k]||x.date>monthly[k].date) monthly[k]=x; });
      return Object.values(monthly).sort((a,b)=>a.date.localeCompare(b.date));
    }

    async function createChart(){
      const ctx=document.getElementById('trendsChart'); if(!ctx) return;
      const points=currentTimeframe==='monthly' ? await getMonthlyDataPoints() : await getWeeklyDataPoints();
      if(!points.length) return;
      const labels=points.map(d=>d.date), data=points.map(d=>d.counts?.total||0);
      if(trendsChart) trendsChart.destroy();
      trendsChart=new Chart(ctx,{type:'line',data:{labels,datasets:[{label:'Total Businesses',data,borderColor:'rgb(59,130,246)',backgroundColor:'rgba(59,130,246,.1)',tension:.1,fill:true}]},
        options:{responsive:true,maintainAspectRatio:true,plugins:{legend:{display:true,position:'top'},tooltip:{callbacks:{label:(c)=>c.dataset.label+': '+c.parsed.y.toLocaleString()}},title:{display:true,text: currentTimeframe==='monthly'?'Monthly Trends (Latest per Month)':'Weekly Trends (All Data Points)'}},scales:{y:{beginAtZero:false,ticks:{callback:(v)=>v.toLocaleString()}}}}});
    }

    async function updateChart(type){
      currentChartType=type;
      ['total','mobile','restaurant','pub','takeaway'].forEach(t=>{
        const b=document.getElementById(`chart-btn-${t}`); b.className= t===type ? 'px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium' : 'px-4 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm font-medium';
      });
      const points=currentTimeframe==='monthly' ? await getMonthlyDataPoints() : await getWeeklyDataPoints(); if(!points.length) return;
      const labels=points.map(d=>d.date); let data,label,color;
      switch(type){
        case 'mobile': data=points.map(d=>d.counts?.[SECTORS.MOBILE]||0); label='Mobile Caterers'; color='rgb(245,158,11)'; break;
        case 'restaurant': data=points.map(d=>d.counts?.[SECTORS.RESTAURANT]||0); label='Restaurants/Cafes'; color='rgb(16,185,129)'; break;
        case 'pub': data=points.map(d=>d.counts?.[SECTORS.PUB]||0); label='Pubs/Bars/Clubs'; color='rgb(139,92,246)'; break;
        case 'takeaway': data=points.map(d=>d.counts?.[SECTORS.TAKEAWAY]||0); label='Takeaways'; color='rgb(239,68,68)'; break;
        default: data=points.map(d=>d.counts?.total||0); label='Total Businesses'; color='rgb(59,130,246)';
      }
      if(trendsChart){
        trendsChart.data.labels=labels;
        trendsChart.data.datasets[0].data=data;
        trendsChart.data.datasets[0].label=label;
        trendsChart.data.datasets[0].borderColor=color;
        trendsChart.data.datasets[0].backgroundColor=color.replace('rgb','rgba').replace(')',', 0.1)');
        trendsChart.update();
      }
    }

    async function exportChartData(){
      const m=await getMonthlyDataPoints(); if(!m.length){alert('No data to export'); return;}
      let csv="Date,Total,Mobile Caterers,Restaurants,Pubs/Bars,Takeaways\n";
      m.forEach(s=>{const c=s.counts||{}; csv += [s.date,c.total||0,c[SECTORS.MOBILE]||0,c[SECTORS.RESTAURANT]||0,c[SECTORS.PUB]||0,c[SECTORS.TAKEAWAY]||0].join(',')+"\n";});
      downloadCSV(csv,`fhrs_trends_data_${new Date().toISOString().slice(0,10)}.csv`);
    }

    function downloadCSV(content,filename){
      const blob=new Blob([content],{type:'text/csv'}); const url=URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=url; a.download=filename; a.click(); URL.revokeObjectURL(url);
    }

    function showCsvMessage(msg,col){
      const box=document.getElementById('csv-message'); box.textContent=msg; box.className=`mt-3 text-sm font-medium ${col}`; box.classList.remove('hidden'); setTimeout(()=>box.classList.add('hidden'),5000);
    }

    async function runPulseCalculations(){
      const all=Object.values(SECTORS); const snaps=await loadAllSnapshots();
      await displayHistoricalTrends(); await createChart();
      if(snaps.length>=2){
        document.getElementById('no-comparison').classList.add('hidden');
        document.getElementById('comparison-view').classList.remove('hidden');
        const nat=calculateSectorPulse(currentData,previousData,all); renderPulseTable('national-trends',nat);
        updateTopGrowth();
      }else{
        document.getElementById('no-comparison').classList.remove('hidden');
        document.getElementById('comparison-view').classList.add('hidden');
        document.getElementById('regional-ranking-growth').innerHTML='<tr><td colspan="4" class="text-center py-4 text-gray-500">Upload again next week to see changes!</td></tr>';
        document.getElementById('regional-ranking-reduction').innerHTML='<tr><td colspan="4" class="text-center py-4 text-gray-500">Upload again next week to see changes!</td></tr>';
      }
      const src=`${currentData.length.toLocaleString()} establishments | ${snaps.length} weeks tracked | ${newBusinesses.length} new businesses identified`;
      document.getElementById('user-info').textContent=src;
    }

    // Boot
    window.onload=async()=>{
      try{
        await initDB();

        // If manual is disabled, hide uploader up-front
        if(!ENABLE_MANUAL){
          document.getElementById('upload-section')?.classList.add('hidden');
        }

        const s=await loadAllSnapshots();
        if(s.length>0){
          document.getElementById('app-content')?.classList.remove('hidden');
          await displayHistoricalTrends(); await updateStorageDisplay(); await createChart();
        }else if(!ENABLE_MANUAL){
          // Friendly note when no committed data yet
          const note=document.createElement('div');
          note.className='card';
          note.textContent='No committed data yet. Run the GitHub Action to generate dashboard data.';
          document.querySelector('main').prepend(note);
        }
      }catch(e){ console.error('Init error:', e); alert('Error initializing database. Refresh the page.'); }
    };
  </script>

  <!-- === FHRS loader (auto-load committed JSON) === -->

  <script>
    async function _maybe(fn,...args){ if(typeof fn==="function"){ return await fn(...args); } }

    // Load committed data into IndexedDB; exclude OTHER from totals
    async function loadCommittedDataOnStart(){
      try{
        const res=await fetch('data/dashboard_data.json?cb='+Date.now(),{cache:'no-store'});
        if(!res.ok) return; // no committed file yet
        const series=await res.json(); // [{date, counts:{...}}]
        await initDB();
        await new Promise((resolve,reject)=>{
          const tx=db.transaction(['snapshots'],'readwrite');
          const store=tx.objectStore('snapshots');

          series.forEach(s=>{
            const c=s.counts||{};
            const monitoredTotal=(c.MOBILE||0)+(c.RESTAURANT_CAFE||0)+(c.PUB_BAR||0)+(c.TAKEAWAY||0); // ignore HOTEL & OTHER
            const mappedCounts={
              [SECTORS.MOBILE]:     c.MOBILE||0,
              [SECTORS.RESTAURANT]: c.RESTAURANT_CAFE||0,
              [SECTORS.PUB]:        c.PUB_BAR||0,
              [SECTORS.TAKEAWAY]:   c.TAKEAWAY||0,
              total: monitoredTotal
            };
            store.put({date:s.date,businesses:[],counts:mappedCounts});
          });

          tx.oncomplete=resolve;
          tx.onerror=()=>reject(tx.error);
        });

        // Show dashboard UI
        document.getElementById('upload-section')?.classList.add('hidden');
        document.getElementById('app-content')?.classList.remove('hidden');

        // Render
        await _maybe(displayHistoricalTrends);
        await _maybe(updateStorageDisplay);
        await _maybe(createChart);
      }catch(e){ console.warn('No committed dashboard data yet:', e); }
    }
    document.addEventListener('DOMContentLoaded', loadCommittedDataOnStart);

    // Manual ‚ÄúFetch latest‚Äù button (polls for updated JSON)
    async function fetchLatestData(){
      const btn=event?.currentTarget; if(btn) btn.disabled=true;
      const deadline=Date.now()+10*60*1000;
      (async function poll(){
        try{
          const res=await fetch('data/dashboard_data.json?cb='+Date.now(),{cache:'no-store'});
          if(res.ok){
            await loadCommittedDataOnStart();
            if(btn) btn.disabled=false;
            return;
          }
        }catch(_){}
        if(Date.now()<deadline){ setTimeout(poll,15000); }
        else { alert('Still running‚Äîcheck back soon.'); if(btn) btn.disabled=false; }
      })();
    }
  </script>

  <!-- === /FHRS loader === -->

  <!-- Top-10 LA deltas loader -->

  <script>
    let __DELTA_CACHE=null;

    async function loadTop10FromAction(){
      try{
        const res=await fetch('data/la_deltas_latest.json?cb='+Date.now(),{cache:'no-store'});
        if(!res.ok) return;
        __DELTA_CACHE=await res.json(); // {date, by_sector:{MOBILE:{growth, reductions}, ...}}
        renderTop10ForSelected();
        const sub=document.getElementById('comparison-sub');
        if(sub && __DELTA_CACHE.date){ sub.textContent=`Comparing latest to previous snapshot as of ${__DELTA_CACHE.date}.`; }
      }catch(e){ console.warn('No LA deltas yet:', e); }
    }

    function renderTop10ForSelected(){
      if(!__DELTA_CACHE) return;
      const map={"Mobile Food Caterers":"MOBILE","Restaurants/Cafes":"RESTAURANT_CAFE","Pubs/Bars/Clubs":"PUB_BAR","Takeaways":"TAKEAWAY","Hotels":"HOTEL","Other":"OTHER"};
      const sel=document.getElementById('growth-sector-select'); if(!sel) return;
      const key=map[sel.options[sel.selectedIndex].text]||"MOBILE";
      const entry=__DELTA_CACHE.by_sector[key]||{growth:[],reductions:[]};

      function render(list,id){
        const tb=document.getElementById(id); if(!tb) return;
        tb.innerHTML='';
        if(!list||!list.length){ tb.innerHTML='<tr><td colspan="4" class="text-center py-4 text-gray-500">No changes this run.</td></tr>'; return; }
        list.forEach((r,i)=>{
          const sign=r.delta>0?'+':'', arrow=r.delta>0?'‚ñ≤':'‚ñº', col=r.delta>0?'text-positive':'text-negative';
          tb.innerHTML+=`<tr><td>${i+1}</td><td class="font-medium text-gray-900">${r.la}</td><td class="text-right ${col} font-semibold">${arrow} ${sign}${r.delta.toLocaleString()}</td><td class="text-right">${r.current.toLocaleString()}</td></tr>`;
        });
      }
      render(entry.growth,'regional-ranking-growth');
      render(entry.reductions,'regional-ranking-reduction');
    }

    document.addEventListener('change',(e)=>{ if(e.target?.id==='growth-sector-select') renderTop10ForSelected(); });
    document.addEventListener('DOMContentLoaded', ()=>{ setTimeout(loadTop10FromAction,300); });

    async function downloadActionCsv(){
      const map={"Mobile caterer":"MOBILE","Restaurant/Cafe/Canteen":"RESTAURANT_CAFE","Pub/bar/nightclub":"PUB_BAR","Takeaway/sandwich shop":"TAKEAWAY"};
      const sel=document.getElementById('sector-select'); const type=map[sel.value]||"MOBILE";
      let ym=new Date().toISOString().slice(0,7);
      try{
        const r=await fetch('data/latest_snapshot.json?cb='+Date.now(),{cache:'no-store'});
        if(r.ok) ym=(await r.json()).date.slice(0,7);
      }catch(_){}
      window.location.href=`data/cumulative/${type}/${ym}.csv`;
    }
  

// ============================================
// DAILY TRACKING FEATURES
// ============================================

let dailyChart = null;
let monthlyChart = null;
let availableMonths = [];
let currentMonthIndex = 0;

// Load last 30 days of daily data
async function loadLast30Days() {
  const loading = document.getElementById('daily-loading');
  const canvas = document.getElementById('daily-chart');
  const status = document.getElementById('daily-status');
  
  try {
    loading.style.display = 'block';
    canvas.style.display = 'none';
    status.style.display = 'none';
    
    const today = new Date();
    const thirtyDaysAgo = new Date(today);
    thirtyDaysAgo.setDate(today.getDate() - 30);
    
    // Only check Nov 2025 for now
    const months = ['2025-11'];
    const dataPoints = [];
    
    for (const month of months) {
      try {
        const res = await fetch(`data/snapshots/${month}.json?cb=${Date.now()}`, {cache: 'no-store'});
        if (!res.ok) continue;
        const snapshot = await res.json();
        const filtered = snapshot.days.filter(d => {
          const date = new Date(d.date + 'T00:00:00');
          return date >= thirtyDaysAgo && date <= today;
        });
        dataPoints.push(...filtered);
      } catch (e) {
        console.log('No data for', month);
      }
    }
    
    loading.style.display = 'none';
    
    if (dataPoints.length < 2) {
      status.textContent = 'Not enough daily data yet. Come back after a few days!';
      status.style.display = 'block';
      return;
    }
    
    dataPoints.sort((a, b) => a.date.localeCompare(b.date));
    
    // Calculate day-to-day changes
    const chartData = [];
    for (let i = 0; i < dataPoints.length; i++) {
      const d = dataPoints[i];
      const prev = i > 0 ? dataPoints[i - 1] : d;
      
      chartData.push({
        date: d.date,
        mobileChange: d.MOBILE - prev.MOBILE,
        restaurantChange: d.RESTAURANT_CAFE - prev.RESTAURANT_CAFE,
        pubChange: d.PUB_BAR - prev.PUB_BAR,
        takeawayChange: d.TAKEAWAY - prev.TAKEAWAY,
        hotelChange: d.HOTEL - prev.HOTEL,
        mobileTotal: d.MOBILE,
        restaurantTotal: d.RESTAURANT_CAFE,
        pubTotal: d.PUB_BAR,
        takeawayTotal: d.TAKEAWAY,
        hotelTotal: d.HOTEL
      });
    }
    
    canvas.style.display = 'block';
    status.textContent = `Showing ${dataPoints.length} days of data`;
    status.style.display = 'block';
    renderDailyChart(chartData);
  } catch (e) {
    loading.style.display = 'none';
    status.textContent = 'Error loading daily data: ' + e.message;
    status.style.display = 'block';
    console.error(e);
  }
}

function renderDailyChart(data) {
  const ctx = document.getElementById('daily-chart').getContext('2d');
  if (dailyChart) dailyChart.destroy();
  
  dailyChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: data.map(d => d.date),
      datasets: [
        {
          label: 'Mobile', 
          data: data.map(d => d.mobileChange || 0), 
          borderColor: '#ef4444', 
          borderWidth: 2, 
          tension: 0.3,
          mobileTotal: data.map(d => d.mobileTotal || 0)
        },
        {
          label: 'Restaurants', 
          data: data.map(d => d.restaurantChange || 0), 
          borderColor: '#10b981', 
          borderWidth: 2, 
          tension: 0.3,
          restaurantTotal: data.map(d => d.restaurantTotal || 0)
        },
        {
          label: 'Pubs', 
          data: data.map(d => d.pubChange || 0), 
          borderColor: '#f59e0b', 
          borderWidth: 2, 
          tension: 0.3,
          pubTotal: data.map(d => d.pubTotal || 0)
        },
        {
          label: 'Takeaways', 
          data: data.map(d => d.takeawayChange || 0), 
          borderColor: '#3b82f6', 
          borderWidth: 2, 
          tension: 0.3,
          takeawayTotal: data.map(d => d.takeawayTotal || 0)
        },
        {
          label: 'Hotels', 
          data: data.map(d => d.hotelChange || 0), 
          borderColor: '#8b5cf6', 
          borderWidth: 2, 
          tension: 0.3,
          hotelTotal: data.map(d => d.hotelTotal || 0)
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      aspectRatio: 3,
      plugins: {
        legend: {position: 'top'},
        tooltip: {
          callbacks: {
            label: function(ctx) {
              const change = ctx.parsed.y;
              const dataset = ctx.dataset;
              let total = 0;
              
              if (dataset.mobileTotal) total = dataset.mobileTotal[ctx.dataIndex];
              else if (dataset.restaurantTotal) total = dataset.restaurantTotal[ctx.dataIndex];
              else if (dataset.pubTotal) total = dataset.pubTotal[ctx.dataIndex];
              else if (dataset.takeawayTotal) total = dataset.takeawayTotal[ctx.dataIndex];
              else if (dataset.hotelTotal) total = dataset.hotelTotal[ctx.dataIndex];
              
              return ctx.dataset.label + ': ' + (change >= 0 ? '+' : '') + change + ' (Total: ' + total.toLocaleString() + ')';
            }
          }
        }
      },
      scales: {
        y: {
          title: {display: true, text: 'Daily Change'},
          ticks: {callback: v => (v >= 0 ? '+' : '') + v}
        }
      }
    }
  });
}

function getMonthsInRange(start, end) {
  const months = [];
  const current = new Date(start.getFullYear(), start.getMonth(), 1);
  const endMonth = new Date(end.getFullYear(), end.getMonth(), 1);
  while (current <= endMonth) {
    months.push(current.toISOString().slice(0, 7));
    current.setMonth(current.getMonth() + 1);
  }
  return months;
}

// Month browser
async function loadAvailableMonths() {
  const select = document.getElementById('month-selector');
  availableMonths = [];
  
  // Build list of months to check (current month + previous 11 months)
  const monthsToCheck = [];
  const today = new Date();
  
  // Start from current month, go back max 12 months
  for (let i = 0; i < 12; i++) {
    const checkDate = new Date(today.getFullYear(), today.getMonth() - i, 1);
    const monthStr = checkDate.toISOString().slice(0, 7);
    
    // Only check from Nov 2025 onwards (when we started daily tracking)
    if (monthStr >= '2025-11') {
      monthsToCheck.push(monthStr);
    }
  }
  
  for (const month of monthsToCheck) {
    try {
      const res = await fetch(`data/snapshots/${month}.json?cb=${Date.now()}`, {cache: 'no-store'});
      if (res.ok) {
        availableMonths.push(month);
      }
    } catch (e) {
      // File doesn't exist, skip silently
    }
  }
  
  if (availableMonths.length === 0) {
    select.innerHTML = '<option>No monthly data yet</option>';
    return;
  }
  
  select.innerHTML = availableMonths.map((m, i) => `<option value="${i}">${formatMonth(m)}</option>`).join('');
  currentMonthIndex = 0;
  loadMonth(0);
}

async function loadMonth(index) {
  if (index < 0 || index >= availableMonths.length) return;
  currentMonthIndex = index;
  const month = availableMonths[index];
  document.getElementById('month-selector').selectedIndex = index;
  
  const loading = document.getElementById('monthly-loading');
  const canvas = document.getElementById('monthly-daily-chart');
  const status = document.getElementById('monthly-status');
  
  try {
    loading.style.display = 'block';
    canvas.style.display = 'none';
    status.style.display = 'none';
    
    const res = await fetch(`data/snapshots/${month}.json?cb=${Date.now()}`, {cache: 'no-store'});
    if (!res.ok) throw new Error('Failed');
    
    const snapshot = await res.json();
    loading.style.display = 'none';
    
    if (snapshot.days.length < 2) {
      status.textContent = 'Not enough data yet';
      status.style.display = 'block';
      return;
    }
    
    // Calculate day-to-day changes (same as daily chart)
    const chartData = [];
    for (let i = 0; i < snapshot.days.length; i++) {
      const d = snapshot.days[i];
      const prev = i > 0 ? snapshot.days[i - 1] : d;
      
      chartData.push({
        date: d.date,
        mobileChange: d.MOBILE - prev.MOBILE,
        restaurantChange: d.RESTAURANT_CAFE - prev.RESTAURANT_CAFE,
        pubChange: d.PUB_BAR - prev.PUB_BAR,
        takeawayChange: d.TAKEAWAY - prev.TAKEAWAY,
        hotelChange: d.HOTEL - prev.HOTEL,
        mobileTotal: d.MOBILE,
        restaurantTotal: d.RESTAURANT_CAFE,
        pubTotal: d.PUB_BAR,
        takeawayTotal: d.TAKEAWAY,
        hotelTotal: d.HOTEL
      });
    }
    
    canvas.style.display = 'block';
    status.textContent = `${formatMonth(month)} - ${snapshot.days.length} days`;
    status.style.display = 'block';
    renderMonthlyDailyChart(chartData);
  } catch (e) {
    loading.style.display = 'none';
    status.textContent = 'Error loading month';
    status.style.display = 'block';
  }
}

function renderMonthlyDailyChart(data) {
  const ctx = document.getElementById('monthly-daily-chart').getContext('2d');
  if (monthlyChart) monthlyChart.destroy();
  
  monthlyChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: data.map(d => d.date.slice(5)),
      datasets: [
        {
          label: 'Mobile', 
          data: data.map(d => d.mobileChange || 0), 
          borderColor: '#ef4444', 
          borderWidth: 2, 
          tension: 0.3,
          mobileTotal: data.map(d => d.mobileTotal || 0)
        },
        {
          label: 'Restaurants', 
          data: data.map(d => d.restaurantChange || 0), 
          borderColor: '#10b981', 
          borderWidth: 2, 
          tension: 0.3,
          restaurantTotal: data.map(d => d.restaurantTotal || 0)
        },
        {
          label: 'Pubs', 
          data: data.map(d => d.pubChange || 0), 
          borderColor: '#f59e0b', 
          borderWidth: 2, 
          tension: 0.3,
          pubTotal: data.map(d => d.pubTotal || 0)
        },
        {
          label: 'Takeaways', 
          data: data.map(d => d.takeawayChange || 0), 
          borderColor: '#3b82f6', 
          borderWidth: 2, 
          tension: 0.3,
          takeawayTotal: data.map(d => d.takeawayTotal || 0)
        },
        {
          label: 'Hotels', 
          data: data.map(d => d.hotelChange || 0), 
          borderColor: '#8b5cf6', 
          borderWidth: 2, 
          tension: 0.3,
          hotelTotal: data.map(d => d.hotelTotal || 0)
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      aspectRatio: 3,
      plugins: {
        legend: {position: 'top'},
        tooltip: {
          callbacks: {
            label: function(ctx) {
              const change = ctx.parsed.y;
              const dataset = ctx.dataset;
              let total = 0;
              
              if (dataset.mobileTotal) total = dataset.mobileTotal[ctx.dataIndex];
              else if (dataset.restaurantTotal) total = dataset.restaurantTotal[ctx.dataIndex];
              else if (dataset.pubTotal) total = dataset.pubTotal[ctx.dataIndex];
              else if (dataset.takeawayTotal) total = dataset.takeawayTotal[ctx.dataIndex];
              else if (dataset.hotelTotal) total = dataset.hotelTotal[ctx.dataIndex];
              
              return ctx.dataset.label + ': ' + (change >= 0 ? '+' : '') + change + ' (Total: ' + total.toLocaleString() + ')';
            }
          }
        }
      },
      scales: {
        y: {
          title: {display: true, text: 'Daily Change'},
          ticks: {callback: v => (v >= 0 ? '+' : '') + v}
        }
      }
    }
  });
}

function loadSelectedMonth() {
  const select = document.getElementById('month-selector');
  loadMonth(parseInt(select.value));
}

function loadPreviousMonth() {
  if (currentMonthIndex < availableMonths.length - 1) loadMonth(currentMonthIndex + 1);
}

function loadNextMonth() {
  if (currentMonthIndex > 0) loadMonth(currentMonthIndex - 1);
}

function formatMonth(monthStr) {
  const date = new Date(monthStr + '-01');
  return date.toLocaleDateString('en-US', { year: 'numeric', month: 'long' });
}

// Enhanced CSV export
async function downloadFilteredCsv() {
  const sectorSelect = document.getElementById('export-sector-select');
  const timeRangeRadio = document.querySelector('input[name="time-range"]:checked');
  const status = document.getElementById('export-status');
  
  if (!timeRangeRadio) {
    status.textContent = 'Please select a time range';
    return;
  }
  
  const timeRange = timeRangeRadio.value;
  const sectorMap = {
    "Mobile caterer": "MOBILE",
    "Restaurant/Cafe/Canteen": "RESTAURANT_CAFE",
    "Pub/bar/nightclub": "PUB_BAR",
    "Takeaway/sandwich shop": "TAKEAWAY",
    "Hotel/bed & breakfast/guest house": "HOTEL"
  };
  
  const sector = sectorMap[sectorSelect.value];
  const today = new Date().toISOString().slice(0, 10);
  const yearMonth = today.slice(0, 7);
  
  status.textContent = 'Downloading...';
  
  try {
    const csvUrl = `data/cumulative/${sector}/${yearMonth}.csv`;
    const res = await fetch(csvUrl);
    
    if (!res.ok) {
      status.textContent = 'No data for this month yet';
      return;
    }
    
    const csvText = await res.text();
    const lines = csvText.split('\n');
    const header = lines[0];
    let filteredLines = [header];
    let filename = '';
    
    if (timeRange === 'month') {
      filteredLines = lines;
      filename = `${sector}_${yearMonth}.csv`;
    } else {
      const cutoffDate = new Date();
      cutoffDate.setDate(cutoffDate.getDate() - parseInt(timeRange));
      const cutoff = cutoffDate.toISOString().slice(0, 10);
      
      for (let i = 1; i < lines.length; i++) {
        const line = lines[i];
        if (!line) continue;
        const dateAdded = line.split(',')[0];
        if (dateAdded >= cutoff) filteredLines.push(line);
      }
      filename = `${sector}_last_${timeRange}_days.csv`;
    }
    
    const blob = new Blob([filteredLines.join('\n')], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.click();
    URL.revokeObjectURL(url);
    
    const count = filteredLines.length - 1;
    status.textContent = `‚úì Downloaded ${count} businesses`;
    setTimeout(() => status.textContent = '', 3000);
  } catch (e) {
    status.textContent = 'Error: ' + e.message;
  }
}

// Initialize on load
setTimeout(() => {
  loadLast30Days();
  loadAvailableMonths();
}, 1000);

</script>

</body>
</html>